var AjaxCrud=function(e){function t(e){e.find("td[data-colspan]").each(function(t,a){var o=$(a),n=o.attr("data-colspan");if(o.attr("colspan")==n){var d=N.cell(o).index().column,l=N.row(e).data();for(o.attr("colspan",""),i=0;i<n-1;i++)d++,o.after("<td>"+l[d]+"</td>"),o=o.next()}})}function a(t,a){"undefined"!=typeof e.hooks[t]&&e.hooks[t](a)}function o(t,a,o){return"undefined"!=typeof e.filters[t]?e.filters[t](a,o):a}function n(e){$input=e.find(".focus-field"),$input.hasClass("select2")?$input.select2("open"):$input.focus()}function d(e){"undefined"!=typeof App&&"undefined"!=typeof App.activate&&App.activate(e)}function l(e,n){"undefined"==typeof n&&(n=!1);var r=$(e.target).closest("tr");if(0==n&&$.blockUI({message:""}),null==j(r,n))return setTimeout(function(){l(e,!0)},150),!1;if(0==j(r,n))return!1;var i=o("saveRowId",r.attr("data-id"),{$row:r}),u={};r.find(".value-field").each(function(e,t){(!$(t).is(":checkbox")||$(t).is(":checked"))&&(u[$(t).attr("name")]=$(t).val())}),u=o("saveRowData",u,{$row:r,id:i});var f=o("saveRowUrl",E.urlAjaxRowPut.replace("_id_",i),{$row:r,id:i,data:u}),c=$.ajax({method:"PUT",url:f,cache:!1,data:u});c.done(function(e){I(r.find(".value-field"));var o=N.row(r).index();t(r),$html=$($.parseHTML($.trim(e))),$dRow=N.row.add($html),N.context[0].aoData[o]=N.context[0].aoData[$dRow.index()],$dRow.remove(),N.draw(!1),r=$(N.row(o).node()),a("saveRowRequestDone",{$row:r}),d(r),$.unblockUI()}),c.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function r(e){var t=$(e.target).closest("tr"),l=t.attr("data-id"),r={};r=o("editRowDataFilter",r,{$row:t}),$.blockUI({message:""});var i=$.ajax({method:"GET",url:E.urlAjaxEditableRowGet.replace("_id_",l),data:r,cache:!1});i.done(function(t){var o=$(e.target).closest("tr"),l=N.row(o).index();I(o.find(".value-field")),$html=$($.parseHTML($.trim(t))),$dRow=N.row.add($html),N.context[0].aoData[l]._aData=N.context[0].aoData[$dRow.index()]._aData,N.context[0].aoData[l].anCells=N.context[0].aoData[$dRow.index()].anCells,N.context[0].aoData[l].nTr=N.context[0].aoData[$dRow.index()].nTr,$dRow.remove(),N.draw(!1),o=$(N.row(l).node()),d(o),A(o.find(".value-field")),n(o),a("editRowRequestDone",{$row:o}),$.unblockUI()}),i.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function u(e){var n=$(e.target).closest("tr"),l=n.attr("data-id"),r={};r=o("cancelRowDataFilter",r,{$row:n}),$.blockUI({message:""});var i=$.ajax({method:"GET",url:E.urlAjaxRowGet.replace("_id_",l),data:r,cache:!1});i.done(function(e){var o=N.row(n).index();I(n.find(".value-field")),t(n),$html=$($.parseHTML($.trim(e))),$dRow=N.row.add($html),N.context[0].aoData[o]._aData=N.context[0].aoData[$dRow.index()]._aData,N.context[0].aoData[o].anCells=N.context[0].aoData[$dRow.index()].anCells,N.context[0].aoData[o].nTr=N.context[0].aoData[$dRow.index()].nTr,$dRow.remove(),N.draw(!1),n=$(N.row(o).node()),d(n),a("cancelRowRequestDone",{$row:n}),$.unblockUI()}),i.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function f(e){var t=$(e.target).attr("data-id");"undefined"==typeof t&&(t=$(e.target).closest("a").attr("data-id"));var n={};n=o("deleteRowDataFilter",n,{id:t,event:e}),$.blockUI({message:""});var d=$.ajax({method:"DELETE",url:E.urlAjaxRowDelete.replace("_id_",t),data:n,cache:!1});d.done(function(n){var d=o("deleteRowRowFilter",T.find('tr[data-id="'+t+'"]'),{id:t,event:e});N.row(d).remove().draw(!1),a("deleteRowDone",{}),$.unblockUI()}),d.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function c(e){var t=$(e.target).closest("tr"),o=t.attr("data-id"),n=$.trim(t.find(".delete-header").html()),d=$.trim(t.find(".delete-body").html());$("#delete-modal .header-text").html("Remove: "+n),$("#delete-modal .body-text").html(d+" will be removed. Ok to proceed?"),$("#delete-modal .ads-delete").attr("data-id",o),$("#delete-modal .ads-delete").off("click.delete"),a("prepareDeleteRowDone",{$row:t}),$("#delete-modal .ads-delete").on("click.delete",function(e){f(e)})}function s(e){var t=T.find("tfoot tr:last"),l={};l=o("addNewRowDataFilter",l,{event:e}),$.blockUI({message:""});var r=$.ajax({method:"GET",url:E.urlAjaxNewRowGet,data:l,cache:!1});r.done(function(e){t.before(e),t=t.prev(),d(t),A(t.find(".value-field")),n(t),a("addNewRowRequestDone",{$row:t}),$.unblockUI()}),r.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function w(e,t){"undefined"==typeof t&&(t=!1);var o=T.find("tfoot");if(0==t&&$.blockUI({message:""}),null==j(o,t))return setTimeout(function(){w(e,!0)},150),!1;if(0==j(o,t))return!1;$.blockUI({message:""});var n={};T.find("tfoot tr.edit-row").each(function(e,t){var a={};$(t).find(".value-field").each(function(e,t){(!$(t).is(":checkbox")||$(t).is(":checked"))&&(a[$(t).attr("name")]=$(t).val())}),n[e]=a});var l=$.ajax({method:"POST",url:E.urlAjaxRowsPost,data:{newRows:n},cache:!1});l.done(function(e){T.find("tfoot tr.edit-row").each(function(e,t){I($(t).find(".value-field"))}),T.find("tfoot tr.edit-row").remove(),T.find("tr:last").hide(),"undefined"!=typeof M&&M.show();var t=$.parseHTML($.trim(e));$(t).each(function(e,t){if("#text"!=$(t).context.nodeName){var a=N.row.add($(t)).draw(!1).node();d($(a))}}),a("saveNewRowsRequestDone",{table:T}),$.unblockUI()}),l.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function v(e){var t=$(e.target).closest("tr");N.row(t).index();I(t.find(".value-field")),t.remove(),1==T.find("tfoot tr").size()&&(T.find("tfoot tr:last").hide(),"undefined"!=typeof M&&M.show()),a("deleteNewRowDone",{table:T})}function m(e){var t={};t=o("editAllRowsDataFilter",t,{}),$.blockUI({message:""});var l=$.ajax({method:"GET",url:E.urlAjaxEditableRowsGet,data:t,cache:!1});l.done(function(e){N.clear(),"undefined"!=typeof G&&G.show(),"undefined"!=typeof q&&q.hide();var t=$.parseHTML($.trim(e));$(t).each(function(e,t){if("#text"!=$(t).context.nodeName){var a=$(N.row.add($(t)).draw(!1).node());d(a),A(a.find(".value-field"))}}),n(T.find("tr:first")),a("editAllRowsRequestDone",{}),$.unblockUI()}),l.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function h(e){"undefined"==typeof recursive&&(recursive=!1);var t=T.find("tbody");if(0==recursive&&$.blockUI({message:""}),null==j(t,recursive))return setTimeout(function(){l(e,!0)},150),!1;if(0==j(t,recursive))return!1;$.blockUI({message:""});var o={};T.find("tbody tr.edit-row").each(function(e,t){var a={};$(t).find(".value-field").each(function(e,t){(!$(t).is(":checkbox")||$(t).is(":checked"))&&(a[$(t).attr("name")]=$(t).val())}),o[e]=a});var n=$.ajax({method:"PUT",url:E.urlAjaxRowsPut,data:{rows:o},cache:!1});n.done(function(e){T.find("tbody tr.edit-row").each(function(e,t){I($(t).find(".value-field"))}),N.clear(),"undefined"!=typeof G&&G.hide(),"undefined"!=typeof q&&q.show();var t=$.parseHTML($.trim(e));$(t).each(function(e,t){if("#text"!=$(t).context.nodeName){var a=N.row.add($(t)).draw(!1).node();d($(a))}}),a("saveAllRowsRequestDone",{table:T}),$.unblockUI()}),n.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function b(e){var t=$(e.target).closest("tr"),o=$("#edit-modal");a("editModalStart",{$modal:o,$row:t});var l=t.attr("data-id");$.blockUI({message:""});var r=$.ajax({method:"GET",url:E.urlAjaxEditableModalGet.replace("_id_",l),cache:!1});r.done(function(e){o.html(e),I(o.find(".value-field")),d(o),o.trigger("create"),A(o.find(".value-field")),n(o),a("editModalRequestDone",{$modal:o}),$.unblockUI()}),r.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function p(e,t){"undefined"==typeof t&&(t=!1);var o=$("#edit-modal");if(a("saveModalStart",{$modal:o}),0==t&&$.blockUI({message:""}),null==j(o,t))return setTimeout(function(){p(e,!0)},150),!1;if(0==j(o,t))return!1;var n=$(e.target).attr("data-id"),l=T.find('tr[data-id="'+n+'"]'),r={};o.find(".value-field").each(function(e,t){(!$(t).is(":checkbox")||$(t).is(":checked"))&&(r[$(t).attr("name")]=$(t).val())});var i=$.ajax({method:"PUT",url:E.urlAjaxModalPut.replace("_id_",n),cache:!1,data:r});i.done(function(e){I(o.find(".value-field"));var t=N.row(l).index();$html=$($.parseHTML($.trim(e))),$dRow=N.row.add($html),N.context[0].aoData[t]=N.context[0].aoData[$dRow.index()],$dRow.remove(),N.draw(!1),l=$(N.row(t).node()),$("#edit-modal").niftyModal("hide"),a("saveModalRequestDone",{$modal:o}),d(l),$.unblockUI(),a("saveModalRequestLast",{$modal:o})}),i.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function x(e){var t=$("#new-modal");a("addNewModalStart",{$modal:t}),$.blockUI({message:""});var o=$.ajax({method:"GET",url:E.urlAjaxNewModalGet,cache:!1});o.done(function(e){t.html(e),d(t),A(t.find(".value-field")),n(t),a("addNewModalRequestDone",{$modal:t}),$.unblockUI()}),o.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function R(e,t){"undefined"==typeof t&&(t=!1);var o=$("#new-modal");if(a("saveNewModalStart",{$modal:o}),0==t&&$.blockUI({message:""}),null==j(o,t))return setTimeout(function(){R(e,!0)},150),!1;if(0==j(o,t))return!1;$.blockUI({message:""});var n={};o.find(".value-field").each(function(e,t){(!$(t).is(":checkbox")||$(t).is(":checked"))&&(n[$(t).attr("name")]=$(t).val())});var l=$.ajax({method:"POST",url:E.urlAjaxModalPost,data:n,cache:!1});l.done(function(e){o.each(function(e,t){I($(t).find(".value-field"))});var t=$.parseHTML($.trim(e)),n=[];$(t).each(function(e,t){if("#text"!=$(t).context.nodeName){var a=N.row.add($(t)).draw(!1).node();n[e]=$(a),d($(a))}}),$("#new-modal").niftyModal("hide"),a("saveNewModalRequestDone",{$modal:o,rows:n}),$.unblockUI(),a("saveNewModalRequestLast",{$modal:o,rows:n})}),l.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}function k(e){if("view"==_){T.prev().find(".dataTables_filter").hide();var t=o("sortRowsColumnIndex",0,{});N.order([t,"asc"]).draw(),_="sort",P.html("Save Sort Order"),"undefined"!=typeof C&&C.show(),T.find("tbody").addClass("sort-body"),T.find("tbody tr td:last-of-type").addClass("sort-column"),T.find("tbody").sortable({helper:function(e,t){var a=t.children(),o=t.clone();return o.children().each(function(e,t){$(t).width(a.eq(e).width())}),o.find(".sort-column").removeClass("sort-column"),o}}),T.find("tbody").sortable("enable"),T.find("tbody").disableSelection(),T.on("order.dt",D)}else{T.prev().find(".dataTables_filter").show(),_="view",P.html("Change Sort Order"),"undefined"!=typeof C&&C.hide(),T.find("tbody").removeClass("sort-body"),T.find("tbody tr td:last-of-type").removeClass("sort-column"),T.find("tbody").sortable("disable"),T.find("tbody").enableSelection();var n=T.find("tbody").sortable("instance"),d=n.toArray({attribute:"data-id"}),l=o("sortRowsDataFilter",{ids:d},{sortable:n});$.blockUI({message:""});var r=$.ajax({method:"PUT",url:E.urlAjaxSortPut,cache:!1,data:l});r.done(function(e){$.unblockUI(),a("sortRowsRequestDone",{}),T.off("order.dt",D)}),r.fail(function(e,t){$.unblockUI(),alert("Request failed: "+t)})}}function y(e){_="view",P.html("Change Sort Order"),C.hide(),T.prev().find(".dataTables_filter").show(),T.find("tbody").sortable("destroy"),T.find("tbody").enableSelection(),T.find("tbody").removeClass("sort-body"),T.find("tbody tr td:last-of-type").removeClass("sort-column");var t=o("sortRowsColumnIndex",0,{});N.order([t,"asc"]).draw(),T.off("order.dt",D)}function D(){var e=o("sortRowsColumnIndex",0,{}),t=N.order();1==t.length?(t[0][0]!=e||"asc"!=t[0][1])&&N.order([[e,"asc"]]).draw():N.order([[e,"asc"]]).draw()}function j(e,t){if("undefined"==typeof t&&(t=!1),"undefined"==typeof U)return!0;t===!1&&U.validateContainer(e);var a=U.isValidContainer(e);return a===!1||null===a?(a===!1&&$.unblockUI(),a):!0}function A(e){"undefined"!=typeof U&&e.each(function(e,t){U.addField($(t))})}function I(e){"undefined"!=typeof U&&e.each(function(e,t){U.resetField($(t))})}var U,g=e.form,T=e.table,M=e.createInitButton,q=e.editAllButton,G=e.saveAllButton,P=e.sortButton,C=e.cancelSortButton,N=T.DataTable(e.datatableArgs),_="view",E={urlAjaxRowGet:e.urls.urlAjaxRowGet,urlAjaxRowPut:e.urls.urlAjaxRowPut,urlAjaxEditableRowGet:e.urls.urlAjaxEditableRowGet,urlAjaxRowsPut:e.urls.urlAjaxRowsPut,urlAjaxEditableRowsGet:e.urls.urlAjaxEditableRowsGet,urlAjaxNewRowGet:e.urls.urlAjaxNewRowGet,urlAjaxRowDelete:e.urls.urlAjaxRowDelete,urlAjaxRowsPost:e.urls.urlAjaxRowsPost,urlAjaxModalPut:e.urls.urlAjaxModalPut,urlAjaxModalPost:e.urls.urlAjaxModalPost,urlAjaxNewModalGet:e.urls.urlAjaxNewModalGet,urlAjaxEditableModalGet:e.urls.urlAjaxEditableModalGet,urlAjaxSortPut:e.urls.urlAjaxSortPut};return T.on("draw.dt",function(){T.find("tbody td[data-colspan]").each(function(e,t){var a=$(t).attr("data-colspan");if($(t).attr("colspan")!=a){for(i=0;i<a-1;i++)$(t).next().remove();$(t).attr("colspan",a)}}),"undefined"!=typeof N&&"undefined"!=typeof P&&(""==$.trim(N.search())?P.show():P.hide())}),N.draw(),T.find("tbody td").each(function(e,t){("undefined"==typeof $(t).attr("data-order")||$(t).attr("data-order").length<1)&&$(t).attr("data-order",$(t).text())}),"undefined"!=typeof g&&(U=g.data("formValidation"),$("[id="+g.attr("id")+"]").length>1&&console.warn("Form Validation will have problems, duplicate IDs detected!")),"undefined"==typeof e.hooks&&(e.hooks={}),"undefined"==typeof e.filters&&(e.filters={}),"undefined"!=typeof g&&g.on("changeDate",".value-field",function(e){"undefined"!=typeof U&&U.revalidateField($(e.target))}),T.on("click",".ads-edit-row",function(e){e.preventDefault(),r(e)}),T.on("click",".ads-prep-del-row",function(e){e.preventDefault(),c(e)}),T.on("click",".ads-delete",function(e){e.preventDefault(),f(e)}),T.on("click",".ads-save-row",function(e){e.preventDefault(),l(e)}),T.on("keypress","input",function(e){if("13"==e.which){var t=$(e.target).closest("tr");return e.preventDefault(),t.attr("data-id")>0?l(e):s(e),!1}}),T.on("click",".ads-cancel-row",function(e){e.preventDefault(),u(e)}),T.on("click",".ads-del-new-row",function(e){e.preventDefault(),v(e)}),T.on("click",".ads-add-new-row",function(e){e.preventDefault(),s(e)}),T.on("click",".ads-save-new-rows",function(e){e.preventDefault(),w(e)}),T.on("click",".ads-edit-modal",function(e){e.preventDefault(),b(e),$("#edit-modal").off(),$("#edit-modal").on("click",".ads-save-modal",function(e){e.preventDefault(),p(e)}),$("#edit-modal").on("click",".md-close",function(e){e.preventDefault(),$("#edit-modal").niftyModal("hide")})}),"undefined"!=typeof M&&$(document).on("click",M.selector,function(e){e.preventDefault(),$(e.target).hasClass("new-modal")?(x(e),$("#new-modal").off(),$("#new-modal").on("click",".ads-save-new-modal",function(e){e.preventDefault(),R(e)}),$("#new-modal").on("click",".md-close",function(e){e.preventDefault(),$("#new-modal").niftyModal("hide")})):(M.hide(),T.find("tfoot tr:last").show(),s(e))}),"undefined"!=typeof P&&P.click(function(e){e.preventDefault(),k(e)}),"undefined"!=typeof C&&C.click(function(e){e.preventDefault(),y(e)}),"undefined"!=typeof q&&q.click(function(e){e.preventDefault(),m(e)}),"undefined"!=typeof G&&G.click(function(e){e.preventDefault(),h(e)}),{form:g,table:T,createInitButton:M,formValidation:U,dataTable:N,urls:E}};