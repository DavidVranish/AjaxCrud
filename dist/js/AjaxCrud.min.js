var AjaxCrud=function(config){var form=config.form;var table=config.table;var createInitButton=config.createInitButton
var formValidation;if(typeof(form)!="undefined"){formValidation=form.data('formValidation');if($('[id='+form.attr('id')+']').length>1){console.warn('Form Validation will have problems, duplicate IDs detected!')}}
var dataTable=table.DataTable(config.datatableArgs);var urls={urlAjaxRowGet:config.urls.urlAjaxRowGet,urlAjaxRowPut:config.urls.urlAjaxRowPut,urlAjaxEditableRowGet:config.urls.urlAjaxEditableRowGet,urlAjaxNewRowGet:config.urls.urlAjaxNewRowGet,urlAjaxRowDelete:config.urls.urlAjaxRowDelete,urlAjaxRowsPost:config.urls.urlAjaxRowsPost,urlAjaxSortPut:""};table.find('tbody td').each(function(){if(typeof($(this).attr('data-order'))=='undefined'||$(this).attr('data-order').length<1){$(this).attr('data-order',$(this).text())}});form.on('changeDate','.value-field',function(event){if(typeof(formValidation)!="undefined"){formValidation.revalidateField($(this))}});table.on('click','.ads-edit-row',function(event){event.preventDefault();editRow(event)});table.on('click','.ads-prep-del-row',function(event){event.preventDefault();prepareDeleteRow(event)});table.on('click','.ads-delete',function(event){event.preventDefault();deleteRow(event)});table.on('click','.ads-save-row',function(event){event.preventDefault();saveRow(event)});table.on('keypress','input',function(event){if(event.which=='13'){var $row=$(event.target).closest('tr');event.preventDefault();if($row.attr('data-id')>0)
saveRow(event);else addNewRow(event);return !1}});table.on('click','.ads-cancel-row',function(event){event.preventDefault();cancelRow(event)});table.on('click','.ads-del-new-row',function(event){event.preventDefault();deleteNewRow(event)});table.on('click','.ads-add-new-row',function(event){event.preventDefault();addNewRow(event)});table.on('click','.ads-save-new-rows',function(event){event.preventDefault();saveNewRows(event)});if(typeof(createInitButton)!="undefined"){createInitButton.click(function(event){event.preventDefault();$(event.target).hide();table.find('tfoot tr:last').show();addNewRow()})}
if(typeof(config.hooks)=="undefined"){config.hooks={}}
function saveRow(event,recursive){if(typeof(recursive)=="undefined"){recursive=!1}
var $row=$(event.target).closest('tr');if(recursive==!1){$.blockUI({message:''})}
if(validationIsValid($row,recursive)==null){setTimeout(function(){saveRow(event,!0)},150);return !1}else if(validationIsValid($row,recursive)==!1){return !1}
var id=$row.attr('data-id');var putData={};$row.find('.value-field').each(function(){if(!($(this).is(':checkbox'))||$(this).is(':checked')){putData[$(this).attr('name')]=$(this).val()}});var request=$.ajax({method:"PUT",url:urls.urlAjaxRowPut.replace("_id_",id),cache:!1,data:putData});request.done(function(html){validationResetFields($row.find('.value-field'));var $rowIndex=dataTable.row($row).index();validationResetFields($row.find('.value-field'));$html=$($.parseHTML($.trim(html)));$dRow=dataTable.row.add($html);$data=$dRow.data();$dRow.remove();dataTable.row($rowIndex).data($data).draw(!1);applyHook('saveRowRequestDone',{"$row":$row});activateJs($row);$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function editRow(event){var $row=$(event.target).closest('tr');var id=$row.attr('data-id');$.blockUI({message:''});var request=$.ajax({method:"GET",url:urls.urlAjaxEditableRowGet.replace("_id_",id),cache:!1});request.done(function(html){var $row=$(event.target).closest('tr');var $rowIndex=dataTable.row($row).index();validationResetFields($row.find('.value-field'));$html=$($.parseHTML($.trim(html)));$dRow=dataTable.row.add($html);$data=$dRow.data();$dRow.remove();dataTable.row($rowIndex).data($data).draw(!1);activateJs($row);validationAddFields($row.find('.value-field'));$row.find("input.focus-field, select.focus-field, textarea.focus-field").focus();applyHook('editRowRequestDone',{"$row":$row});$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function cancelRow(event){var $row=$(event.target).closest('tr');var id=$row.attr('data-id');$.blockUI({message:''});var request=$.ajax({method:"GET",url:urls.urlAjaxRowGet.replace("_id_",id),cache:!1});request.done(function(html){var $rowIndex=dataTable.row($row).index();validationResetFields($row.find('.value-field'));$html=$($.parseHTML($.trim(html)));$dRow=dataTable.row.add($html);$data=$dRow.data();$dRow.remove();dataTable.row($rowIndex).data($data).draw(!1);activateJs($row);$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function deleteRow(event){var id=$(event.target).attr('data-id');if(typeof(id)=="undefined"){id=$(event.target).closest('a').attr('data-id')}
$.blockUI({message:''});var request=$.ajax({method:"DELETE",url:urls.urlAjaxRowDelete.replace("_id_",id),cache:!1});request.done(function(html){dataTable.row(table.find('tr[data-id="'+id+'"]')).remove().draw(!1);$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function prepareDeleteRow(event){var $row=$(event.target).closest('tr');var id=$row.attr('data-id');var headerText=$.trim($row.find('.delete-header').text());var bodyText=$.trim($row.find('.delete-body').text());$('#delete-modal .header-text').text('Remove: '+headerText);$('#delete-modal .body-text').text(bodyText+' will be removed. Ok to proceed?');$("#delete-modal .ads-delete").attr('data-id',id);$("#delete-modal .ads-delete").off('click.delete');$("#delete-modal .ads-delete").on('click.delete',function(event){deleteRow(event)})}
function addNewRow(event){var $row=table.find('tfoot tr:last');$.blockUI({message:''});var request=$.ajax({method:"GET",url:urls.urlAjaxNewRowGet,cache:!1});request.done(function(html){$row.before(html);$row=$row.prev();activateJs($row);validationAddFields($row.find('.value-field'));$row.find("input.focus-field, select.focus-field, textarea.focus-field").focus();applyHook('addNewRowRequestDone',{"$row":$row});$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function saveNewRows(event,recursive){if(typeof(recursive)=="undefined"){recursive=!1}
var $tfoot=table.find('tfoot');if(recursive==!1){$.blockUI({message:''})}
if(validationIsValid($tfoot,recursive)==null){setTimeout(function(){saveRow(event,!0)},150);return !1}else if(validationIsValid($tfoot,recursive)==!1){return !1}
$.blockUI({message:''});var newRowsData={};table.find('tfoot tr.edit-row').each(function(index,element){var newRowData={};$(this).find('.value-field').each(function(index,element){if(!$(this).is(':checkbox')||$(this).is(':checked')){newRowData[$(this).attr('name')]=$(this).val()}});newRowsData[index]=newRowData});var request=$.ajax({method:"POST",url:urls.urlAjaxRowsPost,data:{newRows:newRowsData},cache:!1});request.done(function(html){table.find('tfoot tr.edit-row').each(function(index,element){validationResetFields($(this).find('.value-field'))});table.find('tfoot tr.edit-row').remove();table.find('tr:last').hide();if(typeof(createInitButton)!="undefined"){createInitButton.show()}
var newRows=$.parseHTML($.trim(html));$(newRows).each(function(index,element){if($(this).context.nodeName!="#text"){var row=dataTable.row.add($(this)).draw(!1).node();activateJs($(row))}});applyHook('saveNewRowsRequestDone',{"table":table});$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function deleteNewRow(event){var $row=$(event.target).closest('tr');var $rowIndex=dataTable.row($row).index();console.log('a');validationResetFields($row.find('.value-field'));$row.remove();if(table.find('tfoot tr').size()==1){table.find('tfoot tr:last').hide();if(typeof(createInitButton)!="undefined"){createInitButton.show()}}
applyHook('deleteNewRowDone',{"table":table})}
function sortRows(event){if($(event.target).attr('data-mode')=="sort"){$('table.packaging_sizes').DataTable().order([0,'asc']).draw();$(event.target).attr('data-mode','save');$(event.target).html('Save Sort Order');$('table.packaging_sizes tbody tr').addClass('sort-row');$('table.packaging_sizes tbody').addClass('sort-body');$('table.packaging_sizes tbody tr td:last-of-type').addClass('sort-column');$('table.packaging_sizes tbody').sortable({helper:function(e,tr){var $originals=tr.children();var $helper=tr.clone();$helper.children().each(function(index){$(this).width($originals.eq(index).width())});$helper.find(".sort-column").removeClass('sort-column');return $helper}});$("table.packaging_sizes tbody").sortable("enable");$('table.packaging_sizes tbody').disableSelection()}else{$(event.target).attr('data-mode','sort');$(event.target).html('Change Sort Order');$('table.packaging_sizes tbody tr').removeClass('sort-row');$('table.packaging_sizes tbody').removeClass('sort-body');$('table.packaging_sizes tbody tr td:last-of-type').removeClass('sort-column');$("table.packaging_sizes tbody").sortable("disable");$('table.packaging_sizes tbody').enableSelection();var ids=$('table.packaging_sizes tbody').sortable("toArray",{attribute:"data-id"});$.blockUI({message:''});var request=$.ajax({method:"PUT",url:urls.urlAjaxSortPut,cache:!1,data:{ids:ids}});request.done(function(html){$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}}
function applyHook(hook,args){if(!(typeof(config.hooks[hook])=="undefined")){config.hooks[hook](args)}}
function validationIsValid($container,recursive){if(typeof(recursive)=="undefined"){recursive=!1}
if(typeof(formValidation)=="undefined"){return !0}else{if(recursive===!1){formValidation.validateContainer($container)}
var isValidContainer=formValidation.isValidContainer($container);if(isValidContainer===!1||isValidContainer===null){if(isValidContainer===!1)
$.unblockUI();return isValidContainer}else{return !0}}}
function validationAddFields($fields){if(typeof(formValidation)!="undefined"){$fields.each(function(index,element){formValidation.addField($(this))})}}
function validationResetFields($fields){if(typeof(formValidation)!="undefined"){$fields.each(function(index,element){formValidation.resetField($(this))})}}
function activateJs($parent){if(typeof(App)!="undefined"&&typeof(App.activate)!="undefined"){App.activate($parent)}}
return{form:form,table:table,createInitButton:createInitButton,formValidation:formValidation,dataTable:dataTable,urls:urls}}