var AjaxCrud=function(config){var form=config.form;var table=config.table;var createInitButton=config.createInitButton
var sortButton=config.sortButton;var cancelSortButton=config.cancelSortButton;var formValidation;table.on('draw.dt',function(){table.find('tbody td[data-colspan]').each(function(index,element){var colspan=$(element).attr('data-colspan');if($(element).attr('colspan')!=colspan){for(i=0;i<(colspan-1);i++){$(element).next().remove()}
$(element).attr('colspan',colspan)}});if(typeof(dataTable)!="undefined"&&typeof(sortButton)!="undefined"){if($.trim(dataTable.search())==""){sortButton.show()}else{sortButton.hide()}}});var dataTable=table.DataTable(config.datatableArgs);var sortMode='view';if(typeof(form)!="undefined"){formValidation=form.data('formValidation');if($('[id='+form.attr('id')+']').length>1){console.warn('Form Validation will have problems, duplicate IDs detected!')}}
var urls={urlAjaxRowGet:config.urls.urlAjaxRowGet,urlAjaxRowPut:config.urls.urlAjaxRowPut,urlAjaxEditableRowGet:config.urls.urlAjaxEditableRowGet,urlAjaxNewRowGet:config.urls.urlAjaxNewRowGet,urlAjaxRowDelete:config.urls.urlAjaxRowDelete,urlAjaxRowsPost:config.urls.urlAjaxRowsPost,urlAjaxModalPut:config.urls.urlAjaxModalPut,urlAjaxModalPost:config.urls.urlAjaxModalPost,urlAjaxNewModalGet:config.urls.urlAjaxNewModalGet,urlAjaxEditableModalGet:config.urls.urlAjaxEditableModalGet,urlAjaxSortPut:config.urls.urlAjaxSortPut};table.find('tbody td').each(function(index,element){if(typeof($(element).attr('data-order'))=='undefined'||$(element).attr('data-order').length<1){$(element).attr('data-order',$(element).text())}});if(typeof(form)!="undefined"){form.on('changeDate','.value-field',function(event){if(typeof(formValidation)!="undefined"){formValidation.revalidateField($(event.target))}})}
table.on('click','.ads-edit-row',function(event){event.preventDefault();editRow(event)});table.on('click','.ads-prep-del-row',function(event){event.preventDefault();prepareDeleteRow(event)});table.on('click','.ads-delete',function(event){event.preventDefault();deleteRow(event)});table.on('click','.ads-save-row',function(event){event.preventDefault();saveRow(event)});table.on('keypress','input',function(event){if(event.which=='13'){var $row=$(event.target).closest('tr');event.preventDefault();if($row.attr('data-id')>0)
saveRow(event);else addNewRow(event);return !1}});table.on('click','.ads-cancel-row',function(event){event.preventDefault();cancelRow(event)});table.on('click','.ads-del-new-row',function(event){event.preventDefault();deleteNewRow(event)});table.on('click','.ads-add-new-row',function(event){event.preventDefault();addNewRow(event)});table.on('click','.ads-save-new-rows',function(event){event.preventDefault();saveNewRows(event)});table.on('click','.ads-edit-modal',function(event){event.preventDefault();editModal(event);$('#edit-modal').off();$('#edit-modal').on('click','.ads-save-modal',function(event){event.preventDefault();saveModal(event)});$('#edit-modal').on('click','.md-close',function(event){event.preventDefault();$("#edit-modal").niftyModal("hide")})});if(typeof(createInitButton)!="undefined"){createInitButton.click(function(event){event.preventDefault();if($(event.target).hasClass('new-modal')){addNewModal(event);$('#new-modal').off();$('#new-modal').on('click','.ads-save-new-modal',function(event){event.preventDefault();saveNewModal(event)});$('#new-modal').on('click','.md-close',function(event){event.preventDefault();$('#new-modal').niftyModal("hide")})}else{createInitButton.hide();table.find('tfoot tr:last').show();addNewRow(event)}})}
if(typeof(sortButton)!="undefined"){sortButton.click(function(event){event.preventDefault();sortRows(event)})}
if(typeof(cancelSortButton)!="undefined"){cancelSortButton.click(function(event){event.preventDefault();cancelSortRows(event)})}
if(typeof(config.hooks)=="undefined"){config.hooks={}}
if(typeof(config.filters)=="undefined"){config.filters={}}
function saveRow(event,recursive){if(typeof(recursive)=="undefined"){recursive=!1}
var $row=$(event.target).closest('tr');if(recursive==!1){$.blockUI({message:''})}
if(validationIsValid($row,recursive)==null){setTimeout(function(){saveRow(event,!0)},150);return !1}else if(validationIsValid($row,recursive)==!1){return !1}
var id=applyFilter('saveRowId',$row.attr('data-id'),{'$row':$row});var data={};$row.find('.value-field').each(function(index,element){if(!($(element).is(':checkbox'))||$(element).is(':checked')){data[$(element).attr('name')]=$(element).val()}});data=applyFilter('saveRowData',data,{'$row':$row,'id':id});var url=applyFilter('saveRowUrl',urls.urlAjaxRowPut.replace("_id_",id),{'$row':$row,'id':id,'data':data});var request=$.ajax({method:"PUT",url:url,cache:!1,data:data});request.done(function(html){validationResetFields($row.find('.value-field'));var $rowIndex=dataTable.row($row).index();revertColspan($row);$html=$($.parseHTML($.trim(html)));$dRow=dataTable.row.add($html);$data=$dRow.data();$dRow.remove();dataTable.row($rowIndex).data($data).draw(!1);applyHook('saveRowRequestDone',{"$row":$row});activateJs($row);$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function editRow(event){var $row=$(event.target).closest('tr');var id=$row.attr('data-id');var data={};data=applyFilter('editRowDataFilter',data,{'$row':$row});$.blockUI({message:''});var request=$.ajax({method:"GET",url:urls.urlAjaxEditableRowGet.replace("_id_",id),data:data,cache:!1});request.done(function(html){var $row=$(event.target).closest('tr');var $rowIndex=dataTable.row($row).index();validationResetFields($row.find('.value-field'));$html=$($.parseHTML($.trim(html)));$dRow=dataTable.row.add($html);$data=$dRow.data();$dRow.remove();dataTable.row($rowIndex).data($data).draw(!1);activateJs($row);validationAddFields($row.find('.value-field'));focusInput($row);applyHook('editRowRequestDone',{"$row":$row});$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function cancelRow(event){var $row=$(event.target).closest('tr');var id=$row.attr('data-id');var data={};data=applyFilter('cancelRowDataFilter',data,{'$row':$row});$.blockUI({message:''});var request=$.ajax({method:"GET",url:urls.urlAjaxRowGet.replace("_id_",id),data:data,cache:!1});request.done(function(html){var $rowIndex=dataTable.row($row).index();validationResetFields($row.find('.value-field'));revertColspan($row);$html=$($.parseHTML($.trim(html)));$dRow=dataTable.row.add($html);$data=$dRow.data();$dRow.remove();dataTable.row($rowIndex).data($data).draw(!1);activateJs($row);applyHook('cancelRowRequestDone',{"$row":$row});$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function deleteRow(event){var id=$(event.target).attr('data-id');if(typeof(id)=="undefined"){id=$(event.target).closest('a').attr('data-id')}
var data={};data=applyFilter('deleteRowDataFilter',data,{'id':id,event:event});$.blockUI({message:''});var request=$.ajax({method:"DELETE",url:urls.urlAjaxRowDelete.replace("_id_",id),data:data,cache:!1});request.done(function(html){var $row=applyFilter('deleteRowRowFilter',table.find('tr[data-id="'+id+'"]'),{'id':id,event:event});dataTable.row($row).remove().draw(!1);$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function prepareDeleteRow(event){var $row=$(event.target).closest('tr');var id=$row.attr('data-id');var headerText=$.trim($row.find('.delete-header').text());var bodyText=$.trim($row.find('.delete-body').text());$('#delete-modal .header-text').text('Remove: '+headerText);$('#delete-modal .body-text').text(bodyText+' will be removed. Ok to proceed?');$("#delete-modal .ads-delete").attr('data-id',id);$("#delete-modal .ads-delete").off('click.delete');applyHook('prepareDeleteRowDone',{'$row':$row});$("#delete-modal .ads-delete").on('click.delete',function(event){deleteRow(event)})}
function addNewRow(event){var $row=table.find('tfoot tr:last');var data={};data=applyFilter('addNewRowDataFilter',data,{'event':event});$.blockUI({message:''});var request=$.ajax({method:"GET",url:urls.urlAjaxNewRowGet,data:data,cache:!1});request.done(function(html){$row.before(html);$row=$row.prev();activateJs($row);validationAddFields($row.find('.value-field'));focusInput($row);applyHook('addNewRowRequestDone',{"$row":$row,});$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function saveNewRows(event,recursive){if(typeof(recursive)=="undefined"){recursive=!1}
var $tfoot=table.find('tfoot');if(recursive==!1){$.blockUI({message:''})}
if(validationIsValid($tfoot,recursive)==null){setTimeout(function(){saveRow(event,!0)},150);return !1}else if(validationIsValid($tfoot,recursive)==!1){return !1}
$.blockUI({message:''});var newRowsData={};table.find('tfoot tr.edit-row').each(function(index,element){var newRowData={};$(element).find('.value-field').each(function(index,element){if(!$(element).is(':checkbox')||$(element).is(':checked')){newRowData[$(element).attr('name')]=$(element).val()}});newRowsData[index]=newRowData});var request=$.ajax({method:"POST",url:urls.urlAjaxRowsPost,data:{newRows:newRowsData},cache:!1});request.done(function(html){table.find('tfoot tr.edit-row').each(function(index,element){validationResetFields($(element).find('.value-field'))});table.find('tfoot tr.edit-row').remove();table.find('tr:last').hide();if(typeof(createInitButton)!="undefined"){createInitButton.show()}
var newRows=$.parseHTML($.trim(html));$(newRows).each(function(index,element){if($(element).context.nodeName!="#text"){var row=dataTable.row.add($(element)).draw(!1).node();activateJs($(row))}});applyHook('saveNewRowsRequestDone',{"table":table});$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function deleteNewRow(event){var $row=$(event.target).closest('tr');var $rowIndex=dataTable.row($row).index();validationResetFields($row.find('.value-field'));$row.remove();if(table.find('tfoot tr').size()==1){table.find('tfoot tr:last').hide();if(typeof(createInitButton)!="undefined"){createInitButton.show()}}
applyHook('deleteNewRowDone',{"table":table})}
function sortRows(event){if(sortMode=="view"){table.prev().find('.dataTables_filter').hide();var columnIndex=applyFilter('sortRowsColumnIndex',0,{});dataTable.order([columnIndex,'asc']).draw();sortMode="sort";sortButton.html('Save Sort Order');if(typeof(cancelSortButton)!="undefined"){cancelSortButton.show()}
table.find('tbody').addClass('sort-body');table.find('tbody tr td:last-of-type').addClass('sort-column');table.find('tbody').sortable({helper:function(e,tr){var $originals=tr.children();var $helper=tr.clone();$helper.children().each(function(index,element){$(element).width($originals.eq(index).width())});$helper.find(".sort-column").removeClass('sort-column');return $helper}});table.find('tbody').sortable("enable");table.find('tbody').disableSelection();table.on('order.dt',disableSorting)}else{table.prev().find('.dataTables_filter').show();sortMode="view";sortButton.html('Change Sort Order');if(typeof(cancelSortButton)!="undefined"){cancelSortButton.hide()}
table.find('tbody').removeClass('sort-body');table.find('tbody tr td:last-of-type').removeClass('sort-column');table.find('tbody').sortable("disable");table.find('tbody').enableSelection();var sortable=table.find('tbody').sortable("instance");var ids=sortable.toArray({attribute:"data-id"});var data=applyFilter('sortRowsDataFilter',{ids:ids},{sortable:sortable});$.blockUI({message:''});var request=$.ajax({method:"PUT",url:urls.urlAjaxSortPut,cache:!1,data:data});request.done(function(html){$.unblockUI();applyHook('sortRowsRequestDone',{});table.off('order.dt',disableSorting)});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}}
function cancelSortRows(event){sortMode="view";sortButton.html('Change Sort Order');cancelSortButton.hide();table.prev().find('.dataTables_filter').show();table.find('tbody').sortable("destroy");table.find('tbody').enableSelection();table.find('tbody').removeClass('sort-body');table.find('tbody tr td:last-of-type').removeClass('sort-column');var columnIndex=applyFilter('sortRowsColumnIndex',0,{});dataTable.order([columnIndex,'asc']).draw();table.off('order.dt',disableSorting)}
function disableSorting(){var columnIndex=applyFilter('sortRowsColumnIndex',0,{});var order=dataTable.order();if(order.length==1){if(order[0][0]!=columnIndex||order[0][1]!='asc'){dataTable.order([[columnIndex,"asc"]]).draw()}}else{dataTable.order([[columnIndex,"asc"]]).draw()}}
function editModal(event){var $row=$(event.target).closest('tr');var $modal=$('#edit-modal');var id=$row.attr('data-id');$.blockUI({message:''});var request=$.ajax({method:"GET",url:urls.urlAjaxEditableModalGet.replace("_id_",id),cache:!1});request.done(function(html){$modal.html(html);validationResetFields($modal.find('.value-field'));activateJs($modal);$modal.trigger('create');validationAddFields($modal.find('.value-field'));focusInput($modal);applyHook('editModalRequestDone',{"$modal":$modal});$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function saveModal(event,recursive){if(typeof(recursive)=="undefined"){recursive=!1}
var $modal=$('#edit-modal');if(recursive==!1){$.blockUI({message:''})}
if(validationIsValid($modal,recursive)==null){setTimeout(function(){saveModal(event,!0)},150);return !1}else if(validationIsValid($modal,recursive)==!1){return !1}
var id=$(event.target).attr('data-id');var $row=table.find('tr[data-id="'+id+'"]');var putData={};$modal.find('.value-field').each(function(index,element){if(!($(element).is(':checkbox'))||$(element).is(':checked')){putData[$(element).attr('name')]=$(element).val()}});var request=$.ajax({method:"PUT",url:urls.urlAjaxModalPut.replace("_id_",id),cache:!1,data:putData});request.done(function(html){validationResetFields($modal.find('.value-field'));var $rowIndex=dataTable.row($row).index();$html=$($.parseHTML($.trim(html)));$dRow=dataTable.row.add($html);$data=$dRow.data();$dRow.remove();$row=dataTable.row($rowIndex).data($data).draw(!1).node();$row=$($row);$("#edit-modal").niftyModal("hide");applyHook('saveModalRequestDone',{"$modal":$modal});activateJs($row);$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function addNewModal(event){var $modal=$('#new-modal');$.blockUI({message:''});var request=$.ajax({method:"GET",url:urls.urlAjaxNewModalGet,cache:!1});request.done(function(html){$modal.html(html);activateJs($modal);validationAddFields($modal.find('.value-field'));focusInput($modal);applyHook('addNewModalRequestDone',{"$modal":$modal});$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function saveNewModal(event,recursive){if(typeof(recursive)=="undefined"){recursive=!1}
var $modal=$('#new-modal');if(recursive==!1){$.blockUI({message:''})}
if(validationIsValid($modal,recursive)==null){setTimeout(function(){saveNewModal(event,!0)},150);return !1}else if(validationIsValid($modal,recursive)==!1){return !1}
$.blockUI({message:''});var putData={};$modal.find('.value-field').each(function(index,element){if(!($(element).is(':checkbox'))||$(element).is(':checked')){putData[$(element).attr('name')]=$(element).val()}});var request=$.ajax({method:"POST",url:urls.urlAjaxModalPost,data:putData,cache:!1});request.done(function(html){$modal.each(function(index,element){validationResetFields($(element).find('.value-field'))});var newRows=$.parseHTML($.trim(html));$(newRows).each(function(index,element){if($(element).context.nodeName!="#text"){var row=dataTable.row.add($(element)).draw(!1).node();activateJs($(row))}});$("#new-modal").niftyModal("hide");applyHook('saveNewModalRequestDone',{"$modal":$modal});$.unblockUI()});request.fail(function(jqXHR,textStatus){$.unblockUI();alert("Request failed: "+textStatus)})}
function revertColspan($row){$row.find('td[data-colspan]').each(function(index,element){var $elem=$(element);var colspan=$elem.attr('data-colspan');if($elem.attr('colspan')==colspan){var elemIndex=dataTable.cell($elem).index().column;var rowData=dataTable.row($row).data();$elem.attr('colspan','');for(i=0;i<(colspan-1);i++){elemIndex++;$elem.after('<td>'+rowData[elemIndex]+'</td>');$elem=$elem.next()}}})}
function applyHook(hook,args){if(!(typeof(config.hooks[hook])=="undefined")){config.hooks[hook](args)}}
function applyFilter(filter,def,args){if(!(typeof(config.filters[filter])=="undefined")){return config.filters[filter](def,args)}else{return def}}
function validationIsValid($container,recursive){if(typeof(recursive)=="undefined"){recursive=!1}
if(typeof(formValidation)=="undefined"){return !0}else{if(recursive===!1){formValidation.validateContainer($container)}
var isValidContainer=formValidation.isValidContainer($container);if(isValidContainer===!1||isValidContainer===null){if(isValidContainer===!1)
$.unblockUI();return isValidContainer}else{return !0}}}
function validationAddFields($fields){if(typeof(formValidation)!="undefined"){$fields.each(function(index,element){formValidation.addField($(element))})}}
function validationResetFields($fields){if(typeof(formValidation)!="undefined"){$fields.each(function(index,element){formValidation.resetField($(element))})}}
function focusInput($row){$input=$row.find('.focus-field');if($input.hasClass('select2')){$input.select2('open')}else{$input.focus()}}
function activateJs($parent){if(typeof(App)!="undefined"&&typeof(App.activate)!="undefined"){App.activate($parent)}}
return{form:form,table:table,createInitButton:createInitButton,formValidation:formValidation,dataTable:dataTable,urls:urls}}