function editModal(e){var a=$(e.target).closest("tr"),t=$("#edit-modal");applyHook("editModalStart",{$modal:t,$row:a});var o=a.attr("data-id");$.blockUI({message:""});var l=$.ajax({method:"GET",url:urls.urlAjaxEditableModalGet.replace("_id_",o),cache:!1});l.done(function(e){t.html(e),validationResetFields(t.find(".value-field")),activateJs(t),t.trigger("create"),validationAddFields(t.find(".value-field")),focusInput(t),applyHook("editModalRequestDone",{$modal:t}),$.unblockUI()}),l.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function saveModal(e,a){"undefined"==typeof a&&(a=!1);var t=$("#edit-modal");if(applyHook("saveModalStart",{$modal:t}),0==a&&$.blockUI({message:""}),null==validationIsValid(t,a))return setTimeout(function(){saveModal(e,!0)},150),!1;if(0==validationIsValid(t,a))return!1;var o=$(e.target).attr("data-id"),l=table.find('tr[data-id="'+o+'"]'),d={};t.find(".value-field").each(function(e,a){(!$(a).is(":checkbox")||$(a).is(":checked"))&&(d[$(a).attr("name")]=$(a).val())});var n=$.ajax({method:"PUT",url:urls.urlAjaxModalPut.replace("_id_",o),cache:!1,data:d});n.done(function(e){validationResetFields(t.find(".value-field"));var a=dataTable.row(l).index();$html=$($.parseHTML($.trim(e))),$dRow=dataTable.row.add($html),dataTable.context[0].aoData[a]=dataTable.context[0].aoData[$dRow.index()],$dRow.remove(),dataTable.draw(!1),l=$(dataTable.row(a).node()),$("#edit-modal").niftyModal("hide"),applyHook("saveModalRequestDone",{$modal:t}),activateJs(l),$.unblockUI()}),n.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function addNewModal(e){var a=$("#new-modal");applyHook("addNewModalStart",{$modal:a}),$.blockUI({message:""});var t=$.ajax({method:"GET",url:urls.urlAjaxNewModalGet,cache:!1});t.done(function(e){a.html(e),activateJs(a),validationAddFields(a.find(".value-field")),focusInput(a),applyHook("addNewModalRequestDone",{$modal:a}),$.unblockUI()}),t.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function saveNewModal(e,a){"undefined"==typeof a&&(a=!1);var t=$("#new-modal");if(applyHook("saveNewModalStart",{$modal:t}),0==a&&$.blockUI({message:""}),null==validationIsValid(t,a))return setTimeout(function(){saveNewModal(e,!0)},150),!1;if(0==validationIsValid(t,a))return!1;$.blockUI({message:""});var o={};t.find(".value-field").each(function(e,a){(!$(a).is(":checkbox")||$(a).is(":checked"))&&(o[$(a).attr("name")]=$(a).val())});var l=$.ajax({method:"POST",url:urls.urlAjaxModalPost,data:o,cache:!1});l.done(function(e){t.each(function(e,a){validationResetFields($(a).find(".value-field"))});var a=$.parseHTML($.trim(e)),o=[];$(a).each(function(e,a){if("#text"!=$(a).context.nodeName){var t=dataTable.row.add($(a)).draw(!1).node();o[e]=$(t),activateJs($(t))}}),$("#new-modal").niftyModal("hide"),applyHook("saveNewModalRequestDone",{$modal:t,rows:o}),$.unblockUI()}),l.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function saveRow(e,a){"undefined"==typeof a&&(a=!1);var t=$(e.target).closest("tr");if(0==a&&$.blockUI({message:""}),null==validationIsValid(t,a))return setTimeout(function(){saveRow(e,!0)},150),!1;if(0==validationIsValid(t,a))return!1;var o=applyFilter("saveRowId",t.attr("data-id"),{$row:t}),l={};t.find(".value-field").each(function(e,a){(!$(a).is(":checkbox")||$(a).is(":checked"))&&(l[$(a).attr("name")]=$(a).val())}),l=applyFilter("saveRowData",l,{$row:t,id:o});var d=applyFilter("saveRowUrl",urls.urlAjaxRowPut.replace("_id_",o),{$row:t,id:o,data:l}),n=$.ajax({method:"PUT",url:d,cache:!1,data:l});n.done(function(e){validationResetFields(t.find(".value-field"));var a=dataTable.row(t).index();revertColspan(t),$html=$($.parseHTML($.trim(e))),$dRow=dataTable.row.add($html),dataTable.context[0].aoData[a]=dataTable.context[0].aoData[$dRow.index()],$dRow.remove(),dataTable.draw(!1),t=$(dataTable.row(a).node()),applyHook("saveRowRequestDone",{$row:t}),activateJs(t),$.unblockUI()}),n.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function editRow(e){var a=$(e.target).closest("tr"),t=a.attr("data-id"),o={};o=applyFilter("editRowDataFilter",o,{$row:a}),$.blockUI({message:""});var l=$.ajax({method:"GET",url:urls.urlAjaxEditableRowGet.replace("_id_",t),data:o,cache:!1});l.done(function(a){var t=$(e.target).closest("tr"),o=dataTable.row(t).index();validationResetFields(t.find(".value-field")),$html=$($.parseHTML($.trim(a))),$dRow=dataTable.row.add($html),dataTable.context[0].aoData[o]._aData=dataTable.context[0].aoData[$dRow.index()]._aData,dataTable.context[0].aoData[o].anCells=dataTable.context[0].aoData[$dRow.index()].anCells,dataTable.context[0].aoData[o].nTr=dataTable.context[0].aoData[$dRow.index()].nTr,$dRow.remove(),dataTable.draw(!1),t=$(dataTable.row(o).node()),activateJs(t),validationAddFields(t.find(".value-field")),focusInput(t),applyHook("editRowRequestDone",{$row:t}),$.unblockUI()}),l.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function cancelRow(e){var a=$(e.target).closest("tr"),t=a.attr("data-id"),o={};o=applyFilter("cancelRowDataFilter",o,{$row:a}),$.blockUI({message:""});var l=$.ajax({method:"GET",url:urls.urlAjaxRowGet.replace("_id_",t),data:o,cache:!1});l.done(function(e){var t=dataTable.row(a).index();validationResetFields(a.find(".value-field")),revertColspan(a),$html=$($.parseHTML($.trim(e))),$dRow=dataTable.row.add($html),dataTable.context[0].aoData[t]._aData=dataTable.context[0].aoData[$dRow.index()]._aData,dataTable.context[0].aoData[t].anCells=dataTable.context[0].aoData[$dRow.index()].anCells,dataTable.context[0].aoData[t].nTr=dataTable.context[0].aoData[$dRow.index()].nTr,$dRow.remove(),dataTable.draw(!1),a=$(dataTable.row(t).node()),activateJs(a),applyHook("cancelRowRequestDone",{$row:a}),$.unblockUI()}),l.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function deleteRow(e){var a=$(e.target).attr("data-id");"undefined"==typeof a&&(a=$(e.target).closest("a").attr("data-id"));var t={};t=applyFilter("deleteRowDataFilter",t,{id:a,event:e}),$.blockUI({message:""});var o=$.ajax({method:"DELETE",url:urls.urlAjaxRowDelete.replace("_id_",a),data:t,cache:!1});o.done(function(t){var o=applyFilter("deleteRowRowFilter",table.find('tr[data-id="'+a+'"]'),{id:a,event:e});dataTable.row(o).remove().draw(!1),applyHook("deleteRowDone",{}),$.unblockUI()}),o.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function prepareDeleteRow(e){var a=$(e.target).closest("tr"),t=a.attr("data-id"),o=$.trim(a.find(".delete-header").text()),l=$.trim(a.find(".delete-body").text());$("#delete-modal .header-text").text("Remove: "+o),$("#delete-modal .body-text").text(l+" will be removed. Ok to proceed?"),$("#delete-modal .ads-delete").attr("data-id",t),$("#delete-modal .ads-delete").off("click.delete"),applyHook("prepareDeleteRowDone",{$row:a}),$("#delete-modal .ads-delete").on("click.delete",function(e){deleteRow(e)})}function addNewRow(e){var a=table.find("tfoot tr:last"),t={};t=applyFilter("addNewRowDataFilter",t,{event:e}),$.blockUI({message:""});var o=$.ajax({method:"GET",url:urls.urlAjaxNewRowGet,data:t,cache:!1});o.done(function(e){a.before(e),a=a.prev(),activateJs(a),validationAddFields(a.find(".value-field")),focusInput(a),applyHook("addNewRowRequestDone",{$row:a}),$.unblockUI()}),o.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function saveNewRows(e,a){"undefined"==typeof a&&(a=!1);var t=table.find("tfoot");if(0==a&&$.blockUI({message:""}),null==validationIsValid(t,a))return setTimeout(function(){saveRow(e,!0)},150),!1;if(0==validationIsValid(t,a))return!1;$.blockUI({message:""});var o={};table.find("tfoot tr.edit-row").each(function(e,a){var t={};$(a).find(".value-field").each(function(e,a){(!$(a).is(":checkbox")||$(a).is(":checked"))&&(t[$(a).attr("name")]=$(a).val())}),o[e]=t});var l=$.ajax({method:"POST",url:urls.urlAjaxRowsPost,data:{newRows:o},cache:!1});l.done(function(e){table.find("tfoot tr.edit-row").each(function(e,a){validationResetFields($(a).find(".value-field"))}),table.find("tfoot tr.edit-row").remove(),table.find("tr:last").hide(),"undefined"!=typeof createInitButton&&createInitButton.show();var a=$.parseHTML($.trim(e));$(a).each(function(e,a){if("#text"!=$(a).context.nodeName){var t=dataTable.row.add($(a)).draw(!1).node();activateJs($(t))}}),applyHook("saveNewRowsRequestDone",{table:table}),$.unblockUI()}),l.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function deleteNewRow(e){var a=$(e.target).closest("tr");dataTable.row(a).index();validationResetFields(a.find(".value-field")),a.remove(),1==table.find("tfoot tr").size()&&(table.find("tfoot tr:last").hide(),"undefined"!=typeof createInitButton&&createInitButton.show()),applyHook("deleteNewRowDone",{table:table})}function editAllRows(e){var a={};a=applyFilter("editAllRowsDataFilter",a,{}),$.blockUI({message:""});var t=$.ajax({method:"GET",url:urls.urlAjaxEditableRowsGet,data:a,cache:!1});t.done(function(e){dataTable.clear(),"undefined"!=typeof saveAllButton&&saveAllButton.show(),"undefined"!=typeof editAllButton&&editAllButton.hide();var a=$.parseHTML($.trim(e));$(a).each(function(e,a){if("#text"!=$(a).context.nodeName){var t=$(dataTable.row.add($(a)).draw(!1).node());activateJs(t),validationAddFields(t.find(".value-field"))}}),focusInput(table.find("tr:first")),applyHook("editAllRowsRequestDone",{}),$.unblockUI()}),t.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function saveAllRows(e){"undefined"==typeof recursive&&(recursive=!1);var a=table.find("tbody");if(0==recursive&&$.blockUI({message:""}),null==validationIsValid(a,recursive))return setTimeout(function(){saveRow(e,!0)},150),!1;if(0==validationIsValid(a,recursive))return!1;$.blockUI({message:""});var t={};table.find("tbody tr.edit-row").each(function(e,a){var o={};$(a).find(".value-field").each(function(e,a){(!$(a).is(":checkbox")||$(a).is(":checked"))&&(o[$(a).attr("name")]=$(a).val())}),t[e]=o});var o=$.ajax({method:"PUT",url:urls.urlAjaxRowsPut,data:{rows:t},cache:!1});o.done(function(e){table.find("tbody tr.edit-row").each(function(e,a){validationResetFields($(a).find(".value-field"))}),dataTable.clear(),"undefined"!=typeof saveAllButton&&saveAllButton.hide(),"undefined"!=typeof editAllButton&&editAllButton.show();var a=$.parseHTML($.trim(e));$(a).each(function(e,a){if("#text"!=$(a).context.nodeName){var t=dataTable.row.add($(a)).draw(!1).node();activateJs($(t))}}),applyHook("saveAllRowsRequestDone",{table:table}),$.unblockUI()}),o.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}function sortRows(e){if("view"==sortMode){table.prev().find(".dataTables_filter").hide();var a=applyFilter("sortRowsColumnIndex",0,{});dataTable.order([a,"asc"]).draw(),sortMode="sort",sortButton.html("Save Sort Order"),"undefined"!=typeof cancelSortButton&&cancelSortButton.show(),table.find("tbody").addClass("sort-body"),table.find("tbody tr td:last-of-type").addClass("sort-column"),table.find("tbody").sortable({helper:function(e,a){var t=a.children(),o=a.clone();return o.children().each(function(e,a){$(a).width(t.eq(e).width())}),o.find(".sort-column").removeClass("sort-column"),o}}),table.find("tbody").sortable("enable"),table.find("tbody").disableSelection(),table.on("order.dt",disableSorting)}else{table.prev().find(".dataTables_filter").show(),sortMode="view",sortButton.html("Change Sort Order"),"undefined"!=typeof cancelSortButton&&cancelSortButton.hide(),table.find("tbody").removeClass("sort-body"),table.find("tbody tr td:last-of-type").removeClass("sort-column"),table.find("tbody").sortable("disable"),table.find("tbody").enableSelection();var t=table.find("tbody").sortable("instance"),o=t.toArray({attribute:"data-id"}),l=applyFilter("sortRowsDataFilter",{ids:o},{sortable:t});$.blockUI({message:""});var d=$.ajax({method:"PUT",url:urls.urlAjaxSortPut,cache:!1,data:l});d.done(function(e){$.unblockUI(),applyHook("sortRowsRequestDone",{}),table.off("order.dt",disableSorting)}),d.fail(function(e,a){$.unblockUI(),alert("Request failed: "+a)})}}function cancelSortRows(e){sortMode="view",sortButton.html("Change Sort Order"),cancelSortButton.hide(),table.prev().find(".dataTables_filter").show(),table.find("tbody").sortable("destroy"),table.find("tbody").enableSelection(),table.find("tbody").removeClass("sort-body"),table.find("tbody tr td:last-of-type").removeClass("sort-column");var a=applyFilter("sortRowsColumnIndex",0,{});dataTable.order([a,"asc"]).draw(),table.off("order.dt",disableSorting)}function disableSorting(){var e=applyFilter("sortRowsColumnIndex",0,{}),a=dataTable.order();1==a.length?(a[0][0]!=e||"asc"!=a[0][1])&&dataTable.order([[e,"asc"]]).draw():dataTable.order([[e,"asc"]]).draw()}function validationIsValid(e,a){if("undefined"==typeof a&&(a=!1),"undefined"==typeof formValidation)return!0;a===!1&&formValidation.validateContainer(e);var t=formValidation.isValidContainer(e);return t===!1||null===t?(t===!1&&$.unblockUI(),t):!0}function validationAddFields(e){"undefined"!=typeof formValidation&&e.each(function(e,a){formValidation.addField($(a))})}function validationResetFields(e){"undefined"!=typeof formValidation&&e.each(function(e,a){formValidation.resetField($(a))})}var AjaxCrud=function(e){var a,t=e.form,o=e.table,l=e.createInitButton,d=(e.editAllButton,e.saveAllButton,e.sortButton),n=(e.cancelSortButton,o.DataTable(e.datatableArgs)),r={urlAjaxRowGet:e.urls.urlAjaxRowGet,urlAjaxRowPut:e.urls.urlAjaxRowPut,urlAjaxEditableRowGet:e.urls.urlAjaxEditableRowGet,urlAjaxRowsPut:e.urls.urlAjaxRowsPut,urlAjaxEditableRowsGet:e.urls.urlAjaxEditableRowsGet,urlAjaxNewRowGet:e.urls.urlAjaxNewRowGet,urlAjaxRowDelete:e.urls.urlAjaxRowDelete,urlAjaxRowsPost:e.urls.urlAjaxRowsPost,urlAjaxModalPut:e.urls.urlAjaxModalPut,urlAjaxModalPost:e.urls.urlAjaxModalPost,urlAjaxNewModalGet:e.urls.urlAjaxNewModalGet,urlAjaxEditableModalGet:e.urls.urlAjaxEditableModalGet,urlAjaxSortPut:e.urls.urlAjaxSortPut};return o.on("draw.dt",function(){o.find("tbody td[data-colspan]").each(function(e,a){var t=$(a).attr("data-colspan");if($(a).attr("colspan")!=t){for(i=0;i<t-1;i++)$(a).next().remove();$(a).attr("colspan",t)}}),"undefined"!=typeof n&&"undefined"!=typeof d&&(""==$.trim(n.search())?d.show():d.hide())}),n.draw(),o.find("tbody td").each(function(e,a){("undefined"==typeof $(a).attr("data-order")||$(a).attr("data-order").length<1)&&$(a).attr("data-order",$(a).text())}),"undefined"!=typeof t&&(a=t.data("formValidation"),$("[id="+t.attr("id")+"]").length>1&&console.warn("Form Validation will have problems, duplicate IDs detected!")),"undefined"==typeof e.hooks&&(e.hooks={}),"undefined"==typeof e.filters&&(e.filters={}),{form:t,table:o,createInitButton:l,formValidation:a,dataTable:n,urls:r}};"undefined"!=typeof form&&form.on("changeDate",".value-field",function(e){"undefined"!=typeof formValidation&&formValidation.revalidateField($(e.target))}),table.on("click",".ads-edit-row",function(e){e.preventDefault(),editRow(e)}),table.on("click",".ads-prep-del-row",function(e){e.preventDefault(),prepareDeleteRow(e)}),table.on("click",".ads-delete",function(e){e.preventDefault(),deleteRow(e)}),table.on("click",".ads-save-row",function(e){e.preventDefault(),saveRow(e)}),table.on("keypress","input",function(e){if("13"==e.which){var a=$(e.target).closest("tr");return e.preventDefault(),a.attr("data-id")>0?saveRow(e):addNewRow(e),!1}}),table.on("click",".ads-cancel-row",function(e){e.preventDefault(),cancelRow(e)}),table.on("click",".ads-del-new-row",function(e){e.preventDefault(),deleteNewRow(e)}),table.on("click",".ads-add-new-row",function(e){e.preventDefault(),addNewRow(e)}),table.on("click",".ads-save-new-rows",function(e){e.preventDefault(),saveNewRows(e)}),table.on("click",".ads-edit-modal",function(e){e.preventDefault(),editModal(e),$("#edit-modal").off(),$("#edit-modal").on("click",".ads-save-modal",function(e){e.preventDefault(),saveModal(e)}),$("#edit-modal").on("click",".md-close",function(e){e.preventDefault(),$("#edit-modal").niftyModal("hide")})}),"undefined"!=typeof createInitButton&&createInitButton.click(function(e){e.preventDefault(),$(e.target).hasClass("new-modal")?(addNewModal(e),$("#new-modal").off(),$("#new-modal").on("click",".ads-save-new-modal",function(e){e.preventDefault(),saveNewModal(e)}),$("#new-modal").on("click",".md-close",function(e){e.preventDefault(),$("#new-modal").niftyModal("hide")})):(createInitButton.hide(),table.find("tfoot tr:last").show(),addNewRow(e))}),"undefined"!=typeof sortButton&&sortButton.click(function(e){e.preventDefault(),sortRows(e)}),"undefined"!=typeof cancelSortButton&&cancelSortButton.click(function(e){e.preventDefault(),cancelSortRows(e)}),"undefined"!=typeof editAllButton&&editAllButton.click(function(e){e.preventDefault(),editAllRows(e)}),"undefined"!=typeof saveAllButton&&saveAllButton.click(function(e){e.preventDefault(),saveAllRows(e)});