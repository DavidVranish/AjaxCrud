var AjaxCrud=function(d){function q(a,b){"undefined"==typeof b&&(b=!1);var e=$(a.target).closest("tr");0==b&&$.blockUI({message:""});if(null==r(e,b))return setTimeout(function(){q(a,!0)},150),!1;if(0==r(e,b))return!1;var t=e.attr("data-id"),c={};e.find(".value-field").each(function(){c[$(this).attr("name")]=$(this).val()});t=$.ajax({method:"PUT",url:h.urlAjaxRowPut.replace("_id_",t),cache:!1,data:c});t.done(function(a){l(e.find(".value-field"));var b=f.row(e).index();l(e.find(".value-field"));$html=
$($.parseHTML($.trim(a)));$dRow=f.row.add($html);$data=$dRow.data();$dRow.remove();f.row(b).data($data).draw(!1);m("saveRowRequestDone",{$row:e});n(e);$.unblockUI()});t.fail(function(a,b){$.unblockUI();alert("Request failed: "+b)})}function x(a){var b=$(a.target).closest("tr").attr("data-id");$.blockUI({message:""});b=$.ajax({method:"GET",url:h.urlAjaxEditableRowGet.replace("_id_",b),cache:!1});b.done(function(b){var c=$(a.target).closest("tr"),d=f.row(c).index();l(c.find(".value-field"));$html=$($.parseHTML($.trim(b)));
$dRow=f.row.add($html);$data=$dRow.data();$dRow.remove();f.row(d).data($data).draw(!1);n(c);v(c.find(".value-field"));c.find("input.focus-field, select.focus-field, textarea.focus-field").focus();m("editRowRequestDone",{$row:c});$.unblockUI()});b.fail(function(a,b){$.unblockUI();alert("Request failed: "+b)})}function y(a){var b=$(a.target).closest("tr");a=b.attr("data-id");$.blockUI({message:""});a=$.ajax({method:"GET",url:h.urlAjaxRowGet.replace("_id_",a),cache:!1});a.done(function(a){var c=f.row(b).index();
l(b.find(".value-field"));$html=$($.parseHTML($.trim(a)));$dRow=f.row.add($html);$data=$dRow.data();$dRow.remove();f.row(c).data($data).draw(!1);n(b);$.unblockUI()});a.fail(function(a,b){$.unblockUI();alert("Request failed: "+b)})}function w(a){var b=$(a.target).attr("data-id");"undefined"==typeof b&&(b=$(a.target).closest("a").attr("data-id"));$.blockUI({message:""});a=$.ajax({method:"DELETE",url:h.urlAjaxRowDelete.replace("_id_",b),cache:!1});a.done(function(a){f.row(c.find('tr[data-id="'+b+'"]')).remove().draw(!1);
$.unblockUI()});a.fail(function(a,b){$.unblockUI();alert("Request failed: "+b)})}function z(a){var b=$(a.target).closest("tr");a=b.attr("data-id");var c=$.trim(b.find(".delete-header").text()),b=$.trim(b.find(".delete-body").text());$("#delete-modal .header-text").text("Remove: "+c);$("#delete-modal .body-text").text(b+" will be removed. Ok to proceed?");$("#delete-modal .ads-delete").attr("data-id",a);$("#delete-modal .ads-delete").off("click.delete");$("#delete-modal .ads-delete").on("click.delete",
function(a){w(a)})}function u(a){var b=c.find("tfoot tr:last");$.blockUI({message:""});a=$.ajax({method:"GET",url:h.urlAjaxNewRowGet,cache:!1});a.done(function(a){b.before(a);b=b.prev();n(b);v(b.find(".value-field"));b.find("input.focus-field, select.focus-field, textarea.focus-field").focus();m("addNewRowRequestDone",{$row:b});$.unblockUI()});a.fail(function(a,b){$.unblockUI();alert("Request failed: "+b)})}function A(a,b){"undefined"==typeof b&&(b=!1);var e=c.find("tfoot");0==b&&$.blockUI({message:""});
if(null==r(e,b))return setTimeout(function(){q(a,!0)},150),!1;if(0==r(e,b))return!1;$.blockUI({message:""});var d={};c.find("tfoot tr.edit-row").each(function(a,b){var c={};$(this).find(".value-field").each(function(a,b){c[$(this).attr("name")]=$(this).val()});d[a]=c});e=$.ajax({method:"POST",url:h.urlAjaxRowsPost,data:{newRows:d},cache:!1});e.done(function(a){c.find("tfoot tr.edit-row").each(function(a,b){l($(this).find(".value-field"))});c.find("tfoot tr.edit-row").remove();c.find("tr:last").hide();
"undefined"!=typeof k&&k.show();a=$.parseHTML($.trim(a));$(a).each(function(a,b){if("#text"!=$(this).context.nodeName){var c=f.row.add($(this)).draw(!1).node();n($(c))}});m("saveNewRowsRequestDone",{table:c});$.unblockUI()});e.fail(function(a,b){$.unblockUI();alert("Request failed: "+b)})}function m(a,b){if("undefined"!=typeof d.hooks[a])d.hooks[a](b)}function r(a,b){"undefined"==typeof b&&(b=!1);if("undefined"==typeof g)return!0;!1===b&&g.validateContainer(a);var c=g.isValidContainer(a);return!1===
c||null===c?(!1===c&&$.unblockUI(),c):!0}function v(a){"undefined"!=typeof g&&a.each(function(a,c){g.addField($(this))})}function l(a){"undefined"!=typeof g&&a.each(function(a,c){g.resetField($(this))})}function n(a){"undefined"!=typeof App&&"undefined"!=typeof App.activate&&App.activate(a)}var p=d.form,c=d.table,k=d.createInitButton,g;"undefined"!=typeof p&&(g=p.data("formValidation"),1<$("[id="+p.attr("id")+"]").length&&console.warn("Form Validation will have problems, duplicate IDs detected!"));
var f=c.DataTable(d.datatableArgs),h={urlAjaxRowGet:d.urls.urlAjaxRowGet,urlAjaxRowPut:d.urls.urlAjaxRowPut,urlAjaxEditableRowGet:d.urls.urlAjaxEditableRowGet,urlAjaxNewRowGet:d.urls.urlAjaxNewRowGet,urlAjaxRowDelete:d.urls.urlAjaxRowDelete,urlAjaxRowsPost:d.urls.urlAjaxRowsPost,urlAjaxSortPut:""};c.find("tbody td").each(function(){("undefined"==typeof $(this).attr("data-order")||1>$(this).attr("data-order").length)&&$(this).attr("data-order",$(this).text())});p.on("changeDate",".value-field",function(a){"undefined"!=
typeof g&&g.revalidateField($(this))});c.on("click",".ads-edit-row",function(a){a.preventDefault();x(a)});c.on("click",".ads-prep-del-row",function(a){a.preventDefault();z(a)});c.on("click",".ads-delete",function(a){a.preventDefault();w(a)});c.on("click",".ads-save-row",function(a){a.preventDefault();q(a)});c.on("keypress","input",function(a){if("13"==a.which){var b=$(a.target).closest("tr");a.preventDefault();0<b.attr("data-id")?q(a):u(a);return!1}});c.on("click",".ads-cancel-row",function(a){a.preventDefault();
y(a)});c.on("click",".ads-del-new-row",function(a){a.preventDefault();a=$(a.target).closest("tr");f.row(a).index();console.log("a");l(a.find(".value-field"));a.remove();1==c.find("tfoot tr").size()&&(c.find("tfoot tr:last").hide(),"undefined"!=typeof k&&k.show());m("deleteNewRowDone",{table:c})});c.on("click",".ads-add-new-row",function(a){a.preventDefault();u(a)});c.on("click",".ads-save-new-rows",function(a){a.preventDefault();A(a)});"undefined"!=typeof k&&k.click(function(a){a.preventDefault();
$(a.target).hide();c.find("tfoot tr:last").show();u()});"undefined"==typeof d.hooks&&(d.hooks={});return{form:p,table:c,createInitButton:k,formValidation:g,dataTable:f,urls:h}};
